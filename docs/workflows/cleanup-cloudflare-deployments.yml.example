name: Cleanup Cloudflare Deployments (Optional)

# このワークフローを有効にする手順:
# 1. Cloudflare API Token を作成（Pagesのデプロイメント削除権限が必要）
# 2. GitHub SecretsにCLOUDFLARE_API_TOKENとCLOUDFLARE_ACCOUNT_IDを追加
# 3. このファイルを .yml にリネーム（.example を削除）

on:
  pull_request:
    types: [closed]
  schedule:
    # 毎週日曜日午前4時（UTC）に実行
    - cron: '0 4 * * 0'
  workflow_dispatch:

jobs:
  cleanup-deployments:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          npm install -g wrangler

      - name: List and delete stale preview deployments
        run: |
          # Cloudflare Pagesのプロジェクト名（リポジトリ名と同じと仮定）
          PROJECT_NAME="tree-outliner-sync"

          echo "Fetching deployments for project: $PROJECT_NAME"

          # すべてのデプロイメントを取得
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/$PROJECT_NAME/deployments" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")

          # デプロイメントのブランチ一覧を取得
          DEPLOYMENT_BRANCHES=$(echo "$DEPLOYMENTS" | jq -r '.result[].deployment_trigger.metadata.branch' | sort -u)

          # 現在存在するブランチ一覧を取得
          git fetch origin
          EXISTING_BRANCHES=$(git branch -r | grep 'origin/' | sed 's/origin\///' | tr -d ' ')

          echo "Checking for orphaned deployments..."

          # 削除されたブランチのデプロイメントを削除
          for branch in $DEPLOYMENT_BRANCHES; do
            if ! echo "$EXISTING_BRANCHES" | grep -q "^$branch$"; then
              echo "Branch $branch no longer exists, finding deployments to delete..."

              # このブランチのデプロイメントIDを取得して削除
              DEPLOYMENT_IDS=$(echo "$DEPLOYMENTS" | \
                jq -r ".result[] | select(.deployment_trigger.metadata.branch == \"$branch\") | .id")

              for deployment_id in $DEPLOYMENT_IDS; do
                echo "Deleting deployment: $deployment_id (branch: $branch)"
                curl -s -X DELETE \
                  "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/$PROJECT_NAME/deployments/$deployment_id" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  && echo "✓ Deleted deployment $deployment_id" \
                  || echo "✗ Failed to delete deployment $deployment_id"
              done
            fi
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
